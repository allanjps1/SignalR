

<div class="panel panel-default">
    <div class="panel-body">
        <div class="row">
            <div class="col-md-8 col-xs-8">
                <div id="chat">
                    <form id="frm-send-message" action="#">

                        <div class="row">
                            <div class="col-md-12">
                                <label for="message">Message:</label>
                                <input type="text" id="message" class="form-control" />
                            </div>
                        </div>
                        <br />
                        <input type="submit" id="send" value="Send" class="btn btn-primary" />
                    </form>
                </div>
            </div>
            <div class="col-md-3 col-xs-4">
                    <ul class="list-group" id="UserList"></ul>
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-md-8">
        <div class="panel panel-primary">
            <div class="panel-body">
                <div id="messages">
                </div>
            </div>
        </div>
    </div>
</div>


<!-- MODAL SECTION - MODAL TO SET CONNECTED USER  -->
<div class="modal fade" tabindex="-1" role="dialog" id="userModal" data-keyboard="false" data-backdrop="static">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Modal title</h4>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4">
                        <label for="nomeUsuario">Apelido:</label>
                        <input type="text" id="nomeUsuario" class="form-control" />
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="enter" class="btn btn-primary" data-dismiss="modal">Enter</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<script src="~/lib/jquery/dist/jquery.js"></script>
<script src="~/lib/signalR/signalr-client-1.0.0-alpha2-final.js"></script>

<script>

    // Connection Settings with Hub
    let transportType = signalR.TransportType.WebSockets;
    // Route Hub name defined in Startup
    let http = new signalR.HttpConnection(`multiUsers`, { transport: transportType });
    let connection = new signalR.HubConnection(http);

    $(document).ready(function () {
        $("#userModal").modal("show");
    });

    // Every time when SendMessage is executed do something
    // data = object send to back-end
    // WHen the method SendMessage is invoked do something
    connection.on('SendMessage', (data) => {
        postMessage(data);
    });

    // Every time when SendMessage is executed do something
    // data = object send to back-end
    // WHen the method SendMessage is invoked do something
    connection.on('UsersList', (data) => {
        console.log(data);

        addConnectedUser(data);
    });

    $("#enter").click(function () {

        // Start the connection with Hub
        // Then connection start ends invoke UsersList
        connection.start().catch(err => console.log(err))
            .then(() => {

                let con = connection.connection;

                // Recupera os dados da tela
                let user = {
                    ConnectionID: con.connectionId,
                    Nick: $("#nomeUsuario").val()
                }

                connection.invoke("LogIn", user)
            });
    })

    document.getElementById('frm-send-message').addEventListener('submit', event => {

        // Recupera os dados da tela
        let mensagem = {
            NomeUsuario: $("#nomeUsuario").val(),
            MensagemTexto: $("#message").val()
        }

        // Call Hub method to send data
        connection.invoke('SendMessage', mensagem);

        //Reset message input
        document.getElementById('message').value = '';

        // Prevent Default form submit method
        event.preventDefault();
    });

    function postMessage(data) {
        var divMessages = $("#messages");

        divMessages.append(`<p> <b>${data.nomeUsuario}</b>: ${data.mensagemTexto} </p> `);
    };

    function addConnectedUser(data) {

        var listUsers = $("#UserList");

        listUsers.html("");

        console.log(data);

        $.each(data, function (key, value) {
            listUsers.append(`<li class="list-group-item">${value.nick}</li>`);
        });
    }

</script>
